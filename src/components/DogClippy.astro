---
interface Props {
  facts: string[];
  articleId: string;
}

const { facts, articleId } = Astro.props;
---

<div
  id="dog-clippy"
  class="fixed bottom-20 sm:bottom-24 right-4 sm:right-6 z-[60] opacity-0 pointer-events-none translate-y-8 transition-all duration-400 ease-out"
  role="complementary"
  aria-label="Fun Fact"
  aria-hidden="true"
  data-article-id={articleId}
  data-facts={JSON.stringify(facts)}
>
  <!-- Sprechblase -->
  <div class="dog-clippy-bubble relative bg-white rounded-2xl shadow-xl border border-slate-200 p-4 pb-5 max-w-[280px] max-[400px]:max-w-[220px] mb-1 opacity-0 transition-opacity duration-300">
    <!-- Close-Button -->
    <button
      class="dog-clippy-close absolute -top-2 -right-2 w-7 h-7 bg-white border border-slate-200 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-700 hover:bg-slate-50 transition-colors shadow-sm cursor-pointer"
      aria-label="SchlieÃŸen"
    >
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Label -->
    <span class="text-xs font-semibold text-[var(--color-primary)] uppercase tracking-wider">Wusstest du?</span>

    <!-- Fact-Text -->
    <p class="dog-clippy-fact text-sm text-slate-700 mt-1.5 leading-relaxed"></p>

    <!-- Sprechblasen-Zeiger -->
    <div class="absolute -bottom-[7px] right-8 w-3.5 h-3.5 bg-white border-r border-b border-slate-200 rotate-45"></div>
  </div>

  <!-- Hund SVG -->
  <div class="w-16 h-16 ml-auto mr-2">
    <svg viewBox="0 0 64 64" fill="none" class="w-full h-full drop-shadow-md">
      <!-- Schwanz (animiert) -->
      <path class="dog-clippy-tail" d="M49,42 Q56,34 54,26" stroke="#C67520" stroke-width="3.5" stroke-linecap="round" fill="none"/>
      <!-- Koerper (sitzend) -->
      <ellipse cx="32" cy="46" rx="16" ry="12" fill="#C67520"/>
      <!-- Bauch-Akzent -->
      <ellipse cx="32" cy="48" rx="10" ry="7" fill="#E8913A"/>
      <!-- Linkes Ohr (Schlappohr) -->
      <ellipse cx="20" cy="17" rx="5" ry="9" fill="#a0622a" transform="rotate(-12 20 17)"/>
      <!-- Rechtes Ohr (Schlappohr) -->
      <ellipse cx="44" cy="17" rx="5" ry="9" fill="#a0622a" transform="rotate(12 44 17)"/>
      <!-- Kopf -->
      <circle cx="32" cy="24" r="13" fill="#C67520"/>
      <!-- Schnauze -->
      <ellipse cx="32" cy="29" rx="7.5" ry="5" fill="#E8913A"/>
      <!-- Nase -->
      <ellipse cx="32" cy="27" rx="2.8" ry="1.8" fill="#1e293b"/>
      <!-- Nasen-Glanz -->
      <ellipse cx="31" cy="26.3" rx="1" ry="0.6" fill="#475569" opacity="0.5"/>
      <!-- Linkes Auge -->
      <circle cx="26" cy="22" r="2.5" fill="#1e293b"/>
      <!-- Rechtes Auge -->
      <circle cx="38" cy="22" r="2.5" fill="#1e293b"/>
      <!-- Augen-Glanz links -->
      <circle cx="27" cy="21" r="0.9" fill="white"/>
      <!-- Augen-Glanz rechts -->
      <circle cx="39" cy="21" r="0.9" fill="white"/>
      <!-- Mund (Laecheln) -->
      <path d="M28,31 Q32,34.5 36,31" stroke="#a0622a" stroke-width="1.3" stroke-linecap="round" fill="none"/>
      <!-- Linke Pfote -->
      <ellipse cx="23" cy="56" rx="5" ry="3" fill="#E8913A"/>
      <!-- Rechte Pfote -->
      <ellipse cx="41" cy="56" rx="5" ry="3" fill="#E8913A"/>
      <!-- Pfoten-Details links -->
      <ellipse cx="21" cy="55.5" rx="1.2" ry="1.5" fill="#C67520"/>
      <ellipse cx="25" cy="55.5" rx="1.2" ry="1.5" fill="#C67520"/>
      <!-- Pfoten-Details rechts -->
      <ellipse cx="39" cy="55.5" rx="1.2" ry="1.5" fill="#C67520"/>
      <ellipse cx="43" cy="55.5" rx="1.2" ry="1.5" fill="#C67520"/>
    </svg>
  </div>
</div>

<script>
  let cleanupDogClippy: (() => void) | null = null;

  function initDogClippy() {
    if (cleanupDogClippy) {
      cleanupDogClippy();
      cleanupDogClippy = null;
    }

    const container = document.getElementById('dog-clippy');
    if (!container) return;

    const articleId = container.dataset.articleId || '';
    const factsRaw = container.dataset.facts || '[]';
    let facts: string[];

    try {
      facts = JSON.parse(factsRaw);
    } catch {
      return;
    }

    if (!facts || facts.length === 0) return;

    // Bereits dismissed in dieser Session?
    const storageKey = `dog-clippy-dismissed-${articleId}`;
    try {
      if (sessionStorage.getItem(storageKey)) return;
    } catch {
      // sessionStorage nicht verfuegbar (Private Mode etc.)
    }

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Zufaelligen Fact waehlen
    const randomFact = facts[Math.floor(Math.random() * facts.length)];
    const factEl = container.querySelector('.dog-clippy-fact');
    if (factEl) factEl.textContent = randomFact;

    let hasAppeared = false;
    let scrollThresholdMet = false;
    let timeThresholdMet = false;
    let autoHideTimeoutId: ReturnType<typeof setTimeout> | null = null;

    const SCROLL_THRESHOLD = 0.5;
    const TIME_THRESHOLD = 15000;
    const AUTO_HIDE_DELAY = 30000;

    function showClippy() {
      if (hasAppeared || !scrollThresholdMet || !timeThresholdMet) return;
      hasAppeared = true;

      if (prefersReducedMotion) {
        container.style.transition = 'none';
      }

      container.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-8');
      container.classList.add('opacity-100', 'pointer-events-auto', 'translate-y-0');
      container.setAttribute('aria-hidden', 'false');

      // Sprechblase einblenden (mit Delay)
      const bubble = container.querySelector('.dog-clippy-bubble') as HTMLElement;
      if (bubble) {
        setTimeout(() => {
          bubble.classList.remove('opacity-0');
          bubble.classList.add('opacity-100');
        }, prefersReducedMotion ? 0 : 300);
      }

      // Auto-Hide nach 30 Sekunden
      autoHideTimeoutId = setTimeout(hideClippy, AUTO_HIDE_DELAY);
    }

    function hideClippy() {
      if (prefersReducedMotion) {
        container.style.transition = 'none';
      }

      container.classList.add('opacity-0', 'pointer-events-none', 'translate-y-8');
      container.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
      container.setAttribute('aria-hidden', 'true');

      try {
        sessionStorage.setItem(storageKey, '1');
      } catch {
        // sessionStorage nicht verfuegbar
      }

      if (autoHideTimeoutId) {
        clearTimeout(autoHideTimeoutId);
        autoHideTimeoutId = null;
      }
    }

    // Scroll-Handler (rAF-Throttling)
    let ticking = false;
    const onScroll = () => {
      if (hasAppeared || ticking) return;
      requestAnimationFrame(() => {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = docHeight > 0 ? scrollTop / docHeight : 0;

        if (progress >= SCROLL_THRESHOLD) {
          scrollThresholdMet = true;
          showClippy();
        }
        ticking = false;
      });
      ticking = true;
    };

    // Zeit-Schwelle
    const timeoutId = setTimeout(() => {
      timeThresholdMet = true;
      showClippy();
    }, TIME_THRESHOLD);

    window.addEventListener('scroll', onScroll, { passive: true });

    // Close-Button
    const closeBtn = container.querySelector('.dog-clippy-close');
    const onClose = () => hideClippy();
    if (closeBtn) {
      closeBtn.addEventListener('click', onClose);
    }

    // Cleanup
    cleanupDogClippy = () => {
      window.removeEventListener('scroll', onScroll);
      clearTimeout(timeoutId);
      if (autoHideTimeoutId) clearTimeout(autoHideTimeoutId);
      if (closeBtn) closeBtn.removeEventListener('click', onClose);
    };
  }

  document.addEventListener('astro:page-load', initDogClippy);

  document.addEventListener('astro:before-preparation', () => {
    if (cleanupDogClippy) {
      cleanupDogClippy();
      cleanupDogClippy = null;
    }
  });
</script>
