---
// SearchModal.astro — Pagefind-Suche als Modal-Overlay
// Öffnet sich via Header-Button oder Cmd+K / Ctrl+K
// Pagefind ist rein client-seitig (DSGVO-konform, keine externen Anfragen)
---

<!-- Search Modal Overlay -->
<div
  id="search-modal"
  transition:persist
  class="fixed inset-0 z-[70] flex items-start justify-center pt-[10vh] opacity-0 pointer-events-none transition-opacity duration-200"
  aria-hidden="true"
  role="dialog"
  aria-label="Suche"
>
  <!-- Backdrop -->
  <div id="search-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

  <!-- Modal Content -->
  <div class="relative w-full max-w-2xl mx-4 bg-white rounded-2xl shadow-2xl overflow-hidden max-h-[70vh] flex flex-col">
    <!-- Close button -->
    <button
      id="search-close"
      class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition-colors z-10 cursor-pointer"
      aria-label="Suche schließen"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Keyboard hint -->
    <div class="absolute top-4 right-14 hidden sm:flex items-center gap-1 text-xs text-slate-400">
      <kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-[10px] font-mono">ESC</kbd>
    </div>

    <!-- Pagefind UI container -->
    <div id="search-ui" class="p-4 overflow-y-auto"></div>
  </div>
</div>

<style>
  /* Theme Pagefind Default UI to match site design */
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #E8913A;
    --pagefind-ui-text: #334155;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #e2e8f0;
    --pagefind-ui-tag: #F5E6D3;
    --pagefind-ui-border-width: 2px;
    --pagefind-ui-border-radius: 12px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 16 / 9;
    --pagefind-ui-font: 'Inter', system-ui, -apple-system, sans-serif;
  }
</style>

<script is:inline>
  // Pagefind-Suche: Script läuft inline (nicht von Vite verarbeitet),
  // damit der dynamische Import von /pagefind/pagefind-ui.js nicht
  // zur Build-Zeit aufgelöst wird.
  (function() {
    var searchInstance = null;
    var modal = document.getElementById('search-modal');
    var backdrop = document.getElementById('search-backdrop');
    var closeBtn = document.getElementById('search-close');

    function initSearch() {
      if (searchInstance) return Promise.resolve();
      return new Promise(function(resolve) {
        // CSS laden
        if (!document.querySelector('link[href="/pagefind/pagefind-ui.css"]')) {
          var link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = '/pagefind/pagefind-ui.css';
          document.head.appendChild(link);
        }
        // JS laden
        var script = document.createElement('script');
        script.src = '/pagefind/pagefind-ui.js';
        script.onload = function() {
          try {
            searchInstance = new window.PagefindUI({
              element: '#search-ui',
              showSubResults: true,
              showImages: true,
              translations: {
                placeholder: 'Artikel durchsuchen...',
                zero_results: 'Keine Ergebnisse für [SEARCH_TERM]',
                many_results: '[COUNT] Ergebnisse',
                one_result: '[COUNT] Ergebnis',
                alt_search: 'Keine Ergebnisse. Zeige Ergebnisse für [SEARCH_TERM]',
                search_suggestion: 'Keine Ergebnisse. Versuche eine andere Suche:',
                searching: 'Suche nach [SEARCH_TERM]...',
              },
            });
          } catch(e) {
            // Ignore init errors
          }
          resolve();
        };
        script.onerror = function() {
          var container = document.getElementById('search-ui');
          if (container) {
            container.innerHTML = '<p style="text-align:center;color:#64748b;font-size:14px;padding:16px;">Suche ist nur nach einem Build verfügbar.<br><code style="font-size:12px;background:#f1f5f9;padding:2px 8px;border-radius:4px;">npm run build && npm run preview</code></p>';
          }
          resolve();
        };
        document.head.appendChild(script);
      });
    }

    function openSearch() {
      initSearch().then(function() {
        setTimeout(function() {
          var input = document.querySelector('.pagefind-ui__search-input');
          if (input) input.focus();
        }, 150);
      });
      if (modal) {
        modal.classList.remove('opacity-0', 'pointer-events-none');
        modal.classList.add('opacity-100', 'pointer-events-auto');
        modal.setAttribute('aria-hidden', 'false');
      }
      document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
      if (modal) {
        modal.classList.add('opacity-0', 'pointer-events-none');
        modal.classList.remove('opacity-100', 'pointer-events-auto');
        modal.setAttribute('aria-hidden', 'true');
      }
      document.body.style.overflow = '';
    }

    // Event listeners
    if (backdrop) backdrop.addEventListener('click', closeSearch);
    if (closeBtn) closeBtn.addEventListener('click', closeSearch);

    document.addEventListener('keydown', function(e) {
      // Open with Cmd+K or Ctrl+K
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      // Close with Escape
      if (e.key === 'Escape') {
        closeSearch();
      }
    });

    // Expose globally for Header buttons
    window.__openSearch = openSearch;

    // Modal schließen bei Navigation (View Transitions)
    document.addEventListener('astro:before-preparation', closeSearch);
  })();
</script>
